# Изменения в обработке кредитных отчётов

## Что исправлено

### 1. Обработка ВСЕХ страниц кредитных отчётов
**Было:** Обрабатывались только первые 25 страниц  
**Стало:** Обрабатываются ВСЕ страницы отчёта  

```python
# Раньше: max_pages = min(25, len(pdf))
# Теперь: total_pages = len(pdf)  # ВСЕ страницы
```

### 2. Улучшенный промпт с детальными инструкциями
Добавлены критические инструкции для GPT:

- **Проверка погашенных долгов:** Если в поле "Прекращение обязательств" указано "Н/Д" — долг НЕ погашен, включать в список. Если указана дата — долг погашен, НЕ включать.

- **Раздел "Задолженность":** Смотреть на последнюю строку:
  - Если задолженность > 0 — долг ЕСТЬ
  - Если = 0 или "Н/Д" — долг погашен

- **Обязательные поля для извлечения:**
  - ИНН/ОГРН кредитора
  - Дата договора (НЕ путать с датой обновления!)
  - Тип обязательства (кредит/карта/ипотека/микрозаём)
  - Сумма задолженности из раздела "Задолженность"

- **Обработка множественных кредитов:** Если один кредитор встречается несколько раз (например, 3 кредита в Сбербанке) — перечислять ОТДЕЛЬНЫМИ записями с разными датами договора.

### 3. Дедупликация по ИНН/ОГРН + дата договора
**Было:** Дедупликация только по названию кредитора → дубли накручивали сумму долга  
**Стало:** Дедупликация по уникальному ключу `ИНН:xxx|ДАТА:дд.мм.гггг`

```python
# Формируется уникальный ключ:
if инн:
    dedup_key = f"ИНН:{инн}|ДАТА:{дата_договора}"
elif огрн:
    dedup_key = f"ОГРН:{огрн}|ДАТА:{дата_договора}"
else:
    dedup_key = f"НЗВ:{кредитор_normalized}|ДАТА:{дата_договора}"
```

При обнаружении дубликата:
- Берётся запись с большей суммой (более свежие данные)
- В лог выводится `[DEDUP] Обновление...` или `[DEDUP] Пропуск дубликата...`

### 4. Добавлена поддержка НБКИ
Добавлен тип отчёта `"отчет_нбки"` в список кредитных отчётов (раньше обрабатывались только ОКБ и БКИ/Скоринг).

## Как это работает

### Схема обработки:
1. **PDF → Изображения:** Все страницы конвертируются в JPG (200 DPI)
2. **GPT Vision:** Все страницы отправляются в GPT-4o с детальным промптом
3. **Извлечение:** GPT извлекает ФИО, список кредиторов с ИНН/ОГРН/датами, суммы задолженности
4. **Объединение:** `merge_credit_reports()` объединяет данные из всех отчётов (ОКБ + БКИ + НБКИ)
5. **Дедупликация:** По ИНН/ОГРН + дата договора → остаются только уникальные долги
6. **Итог:** Корректная сумма долга без дублей

### Пример дедупликации:
```
Отчёт ОКБ: ПАО Сбербанк, ИНН 7707083893, договор 08.04.2024, долг 70000 руб
Отчёт БКИ: ПАО Сбербанк, ИНН 7707083893, договор 08.04.2024, долг 69101 руб
                                ↓
                     Результат: 70000 руб (берём большую сумму)
```

## Рекомендации

### Для получения корректных данных:
1. **Перегенерировать outputs для всех должников** — старые `result.json` не содержат ИНН/ОГРН и могут иметь дубли.
   
2. **Проверить качество PDF кредитных отчётов:**
   - Все страницы должны быть читаемы
   - Текст не должен быть размыт/повёрнут
   - Таблицы должны быть чёткими

3. **Мониторить логи при обработке:**
   - `[CREDIT] Обработка кредитного отчета (Vision API)`
   - `OK (X стр.)` — показывает, сколько страниц обработано
   - `[DEDUP] Обновление...` — показывает дедупликацию в реальном времени

### Тестирование:
```powershell
# Запустить тест на последнем обработанном должнике:
python .\test_credit_processing.py
```

Проверит:
- Количество кредиторов
- Наличие ИНН/дат договоров
- Дубликаты по ИНН + дата
- Итоговую сумму долга

## Файлы изменены:
- `processor.py`:
  - Строки ~4565–4580: Убрано ограничение на 25 страниц
  - Строки ~4595–4610: Использование промптов из DOCUMENT_TYPES + критические инструкции
  - Строки ~3263–3370: Улучшенная функция `merge_credit_reports()` с дедупликацией по ИНН/ОГРН

## Удалить временные файлы:
```powershell
Remove-Item .\test_credit_processing.py
```
