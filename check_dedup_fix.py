"""
Проверка исправления дедупликации на реальных данных
"""
import json
from decimal import Decimal
from processor import DocumentProcessor

# Загружаем исходные parsed данные (не result.json, а data_map)
# Попробуем найти parsed.json
import os
case_dir = "outputs/cd3148a0-effd-4c78-9b42-fca24ab66b64"

print("=" * 80)
print("ПРОВЕРКА ДЕДУПЛИКАЦИИ ПО НАЗВАНИЕ + ДАТА")
print("=" * 80)

# Создаём тестовые данные - симулируем то, что GPT извлёк из документов
# Это два дубликата Сбербанка с одинаковой датой
test_data_map = {
    "отчет_бки": [
        {
            "ФИО": "Кузьмич Николай Павлович",
            "Договоры": [
                {
                    "Номер_в_отчете": "3",
                    "Кредитор": "ПАО Сбербанк",
                    "ИНН_кредитора": "7707083893",
                    "Дата_сделки": "21.05.2023",
                    "Вид": "Иной необеспеченный заем",
                    "Текущая_задолженность": "81604.53",
                    "Просрочка": "1589.70",
                    "Статус": "Активен"
                },
                {
                    "Номер_в_отчете": "4",
                    "Кредитор": "ПАО Сбербанк",  
                    "ИНН_кредитора": "7707083893",
                    "Дата_сделки": "21.05.2023",  # ТА ЖЕ ДАТА!
                    "Вид": "Иной необеспеченный заем",
                    "Текущая_задолженность": "79464.33",
                    "Просрочка": "1589.70",
                    "Статус": "Активен"
                }
            ]
        }
    ]
}

print("\nИсходные данные:")
print("  - Сбербанк, 21.05.2023, задолженность 81604.53 + 1589.70 = 83194.23")
print("  - Сбербанк, 21.05.2023, задолженность 79464.33 + 1589.70 = 81054.03")
print("\nОжидаемый результат: ОДИН кредит с бОльшей суммой (83194.23)\n")

# Формируем таблицу кредиторов
table = DocumentProcessor.format_creditors_table(
    test_data_map,
    debtor_fio="Кузьмич Николай Павлович",
    debtor_inn="243301647052",
    debtor_snils="152-782-898 01",
    debtor_address="г. Челябинск"
)

credits = table.get("credits", [])

print(f"\nРезультат: {len(credits)} кредитор(ов)")

for idx, credit in enumerate(credits, 1):
    print(f"\n{idx}. {credit.get('Кредитор', '?')}")
    print(f"   ИНН: {credit.get('ИНН_кредитора', '?')}")
    print(f"   Дата: {credit.get('Дата_договора', '?')}")
    print(f"   Полная сумма: {credit.get('Полная_сумма_обязательства', '?')}")
    print(f"   Задолженность: {credit.get('Задолженность_в_том_числе', '?')}")

if len(credits) == 1:
    print("\n✅ ТЕСТ ПРОЙДЕН: Дубликат успешно удалён!")
    debt = float(credit.get('Задолженность_в_том_числе', '0'))
    if abs(debt - 81604.53) < 0.01:
        print(f"   Выбрана бОльшая сумма: {debt}")
    else:
        print(f"   ⚠️  Сумма {debt} не совпадает с ожидаемой 81604.53")
elif len(credits) == 2:
    print("\n❌ ТЕСТ НЕ ПРОЙДЕН: Дубликат НЕ удалён, оба кредита в таблице!")
else:
    print(f"\n⚠️  Неожиданное количество кредитов: {len(credits)}")

print("\n" + "=" * 80)
